{% extends "_base.html" %}
{% block title %}Inicio - LongShortDjango{% endblock %}
{% block content %}
<div class="py-3">
  <div class="mb-3">
    <h1 class="h5 fw-semibold mb-1">Operacoes em andamento</h1>
    <p class="text-body-secondary small mb-0">
      Acompanhe as metricas de cada operacao aberta. Clique em um card para revisar ou encerrar.
    </p>
  </div>

  {% if operations_cards %}
    <div class="row g-3">
      {% for item in operations_cards %}
        <div class="col-12 col-lg-6 col-xxl-4">
          <div class="card soft-card shadow-sm rounded-4 h-100">
              <div class="card-body d-flex flex-column gap-3">
                <!-- CabeÃ§alho -->
                <div class="d-flex justify-content-between align-items-start gap-3">
                <div class="d-flex flex-column gap-2">
                  <div>
                    <div class="text-uppercase small text-danger fw-semibold">Vender</div>
                    <div>
                      <a href="{{ item.sell_link }}"
                         class="btn btn-link p-0 text-danger fw-semibold"
                         target="_blank"
                         rel="noreferrer">
                        {{ item.operation.sell_asset.ticker }}
                      </a>
                    </div>
                  </div>
                  <div>
                    <div class="text-uppercase small text-success fw-semibold">Comprar</div>
                    <div>
                      <a href="{{ item.buy_link }}"
                         class="btn btn-link p-0 text-success fw-semibold"
                         target="_blank"
                         rel="noreferrer">
                        {{ item.operation.buy_asset.ticker }}
                      </a>
                    </div>
                  </div>
                  <div class="text-body-secondary small">
                    Aberta em {{ item.operation_date_label }} — Janela {{ item.operation.window }}d
                  </div>
                </div>
                  <div class="d-flex flex-column align-items-end gap-2">
                    <span class="badge {% if item.operation.is_real %}bg-success-subtle text-success{% else %}bg-secondary-subtle text-secondary{% endif %}">
                      {% if item.operation.is_real %}Conta real{% else %}Simulacao{% endif %}
                    </span>
                    <div class="d-flex gap-1">
                      <a href="{{ item.url }}" class="btn btn-sm btn-outline-primary">Detalhes</a>
                    </div>
                  </div>
                </div>
                <!-- Z-score resumo -->
                <div class="d-flex align-items-center gap-2 small">
                  <div>
                    <span class="text-body-tertiary">Z entrada:</span>
                    <span class="fw-semibold">{{ item.entry.zscore_label }}</span>
                    {% if item.entry_reference_label %}
                      <span class="text-body-tertiary">(Snapshot {{ item.entry_reference_label }})</span>
                    {% endif %}
                  </div>
                  <span class="text-body-tertiary">â€¢</span>
                  <div>
                    <span class="text-body-tertiary">Z atual:</span>
                    <span class="fw-semibold">{{ item.current.zscore_label }}</span>
                  </div>
                  <span class="badge {% if item.is_delta_positive %}bg-success-subtle text-success{% else %}bg-danger-subtle text-danger{% endif %} ms-auto">{{ item.z_delta_label }}</span>
                </div>

                {% if item.current.prices.updated_label %}
                  <div class="text-body-tertiary small">Atualizado {{ item.current.prices.updated_label }}</div>
                {% endif %}

                <!-- Boleta resumida: Entrada x Atual x P/L -->
                <div class="border rounded-3 p-3 small">
                  <div class="text-uppercase text-body-tertiary fw-semibold small mb-2">Boleta</div>
                  <div class="table-responsive">
                    <table class="table table-sm align-middle mb-0">
                      <thead>
                        <tr class="text-body-tertiary">
                          <th scope="col">Ponta</th>
                          <th scope="col" class="text-end">Qtd</th>
                          <th scope="col" class="text-end">PreÃ§o</th>
                          <th scope="col" class="text-end">P/L</th>
                        </tr>
                      </thead>
                      <tbody>
                        <tr class="table-light text-uppercase text-body-tertiary small">
                          <td colspan="4">Entrada</td>
                        </tr>
                        <tr>
                          <td class="text-danger">Vender <span class="fw-semibold">{{ item.operation.sell_asset.ticker }}</span></td>
                          <td class="text-end">{{ item.entry.prices.sell_qty_label }}</td>
                          <td class="text-end">{{ item.entry.prices.sell_price_label }}</td>
                          <td class="text-end">{{ item.entry.prices.sell_total_label }}</td>
                        </tr>
                        <tr>
                          <td class="text-success">Comprar <span class="fw-semibold text-success">{{ item.operation.buy_asset.ticker }}</span></td>
                          <td class="text-end">{{ item.entry.prices.buy_qty_label }}</td>
                          <td class="text-end">{{ item.entry.prices.buy_price_label }}</td>
                          <td class="text-end">{{ item.entry.prices.buy_total_label }}</td>
                        </tr>
                        <tr class="table-light text-uppercase text-body-tertiary small">
                          <td colspan="4">Atual</td>
                        </tr>
                        <tr>
                          <td class="text-danger">Vender <span class="fw-semibold">{{ item.operation.sell_asset.ticker }}</span></td>
                          <td class="text-end">{{ item.entry.prices.sell_qty_label }}</td>
                          <td class="text-end">{{ item.current.prices.sell_price_label }}</td>
                          <td class="text-end">{{ item.current.prices.sell_pl_label }}</td>
                        </tr>
                        <tr>
                          <td class="text-success">Comprar <span class="fw-semibold text-success">{{ item.operation.buy_asset.ticker }}</span></td>
                          <td class="text-end">{{ item.entry.prices.buy_qty_label }}</td>
                          <td class="text-end">{{ item.current.prices.buy_price_label }}</td>
                          <td class="text-end">{{ item.current.prices.buy_pl_label }}</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>

                <!-- Resumo financeiro -->
                <div class="card border rounded-3 p-3 small">
                  <div class="row gy-1">
                    <div class="col-6 d-flex justify-content-between">
                      <span class="text-body-tertiary">Capital alocado</span>
                      <span class="fw-semibold">{{ item.capital_label }}</span>
                    </div>
                    <div class="col-6 d-flex justify-content-between">
                      <span class="text-body-tertiary">Saldo entrada</span>
                      <span class="fw-semibold">{{ item.entry.prices.net_label }}</span>
                    </div>
                    <div class="col-6 d-flex justify-content-between">
                      <span class="text-body-tertiary">Saldo atual</span>
                      <span class="fw-semibold">{{ item.current.prices.net_label }}</span>
                    </div>
                    <div class="col-6 d-flex justify-content-between">
                      <span class="text-body-tertiary">Resultado</span>
                      <span class="fw-semibold {% if item.pnl_ready %}{% if item.pnl_positive %}text-success{% elif item.pnl_negative %}text-danger{% endif %}{% endif %}">{{ item.current.prices.pl_total_label }}</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="card soft-card shadow-sm rounded-4">
      <div class="card-body">
        <h2 class="h6 fw-semibold mb-1">Nenhuma operacao em andamento</h2>
        <p class="text-body-secondary small mb-0">
          Monte uma operacao na aba Operacoes para acompanhar os cards aqui.
        </p>
      </div>
    </div>
  {% endif %}
</div>
{% endblock %}
