{% extends "_base.html" %}

{% block content %}
<div class="py-3">
  <div class="mb-3">
    <h1 class="h5 fw-semibold mb-1">Operacoes</h1>
    <p class="text-body-secondary small mb-0">Informe manualmente o par ou carregue os dados trazidos da analise.</p>
  </div>

  {% if prefilled %}
    <div class="alert alert-primary small mb-3">
      Dados importados da analise. Reveja os campos antes de iniciar a operacao.
    </div>
  {% endif %}

  <div class="row g-3">
    <div class="col-lg-8">
      <div class="card shadow-sm rounded-4 soft-card h-100">
        <div class="card-body">
          <h2 class="h6 fw-semibold mb-3">Configurar Par</h2>
          <form id="operationDraftForm" class="row g-3" autocomplete="off" novalidate>
            <input type="hidden" name="pair_id" value="{{ initial.pair_id }}">
            <input type="hidden" name="source" value="{{ initial.source }}">
            <div class="col-sm-6">
              <label for="tickerLeft" class="form-label small text-body-secondary">Ativo esquerdo</label>
              <input type="text"
                     class="form-control"
                     id="tickerLeft"
                     name="left"
                     placeholder="PETR4"
                     value="{{ initial.left }}"
                     maxlength="16">
            </div>
            <div class="col-sm-6">
              <label for="tickerRight" class="form-label small text-body-secondary">Ativo direito</label>
              <input type="text"
                     class="form-control"
                     id="tickerRight"
                     name="right"
                     placeholder="VALE3"
                     value="{{ initial.right }}"
                     maxlength="16">
            </div>
            <div class="col-sm-4">
              <label for="windowSelect" class="form-label small text-body-secondary">Janela de referencia</label>
              <select class="form-select" id="windowSelect" name="window">
                {% for item in window_options %}
                  <option value="{{ item }}" {% if item == initial.window %}selected{% endif %}>{{ item }} dias</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-sm-8 d-flex align-items-end">
              <div class="text-body-secondary small">
                Escolha a janela sugerida pela analise ou ajuste manualmente conforme sua estrategia.
              </div>
            </div>
            <div class="col-12">
              <div class="d-flex gap-2">
                <button type="button" class="btn btn-primary" disabled title="Fluxo de execucao sera habilitado na proxima etapa">
                  Salvar e iniciar (em breve)
                </button>
                <button type="button" class="btn btn-outline-secondary" disabled>
                  Apenas registrar (em breve)
                </button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div class="col-lg-4">
      <div class="card shadow-sm rounded-4 h-100">
        <div class="card-body d-flex flex-column gap-3">
          <div>
            <h2 class="h6 fw-semibold mb-3">Resumo</h2>
            <dl class="row mb-0 small">
              <dt class="col-5 text-body-secondary">Origem</dt>
              <dd class="col-7">
                {% if initial.source == "analysis" %}
                  Analise
                {% else %}
                  Manual
                {% endif %}
              </dd>
              <dt class="col-5 text-body-secondary">Par</dt>
              <dd class="col-7">
                {% if pair_obj %}
                  {{ pair_obj.left.ticker }} x {{ pair_obj.right.ticker }}
                  <span class="text-body-tertiary d-block">ID #{{ pair_obj.pk }}</span>
                {% elif initial.left or initial.right %}
                  {{ initial.left|default:"--" }} x {{ initial.right|default:"--" }}
                {% else %}
                  --
                {% endif %}
              </dd>
              <dt class="col-5 text-body-secondary">Janela</dt>
              <dd class="col-7">{{ initial.window }} dias</dd>
              {% if summary.zscore_label %}
                <dt class="col-5 text-body-secondary">Z-score</dt>
                <dd class="col-7">{{ summary.zscore_label }}</dd>
              {% endif %}
            </dl>
          </div>
          {% if summary.note %}
            <p class="small text-body-secondary mb-0">{{ summary.note }}</p>
          {% endif %}
          <div class="d-grid gap-2">
            <div class="border rounded-3 p-3">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <div class="text-uppercase small text-danger fw-semibold">{{ summary.sell.label }}</div>
                  <div class="fw-semibold">{{ summary.sell.ticker|default:"--" }}</div>
                  {% if summary.sell.name %}
                    <div class="text-body-secondary small">{{ summary.sell.name }}</div>
                  {% endif %}
                </div>
                <div class="text-end">
                  {% if summary.sell.price_label %}
                    <div class="fw-semibold">{{ summary.sell.price_label }}</div>
                    {% if summary.sell.source_label or summary.sell.updated_label %}
                      <div class="text-body-tertiary small">
                        {% if summary.sell.source_label %}{{ summary.sell.source_label }}{% endif %}
                        {% if summary.sell.source_label and summary.sell.updated_label %}&bull; {% endif %}
                        {% if summary.sell.updated_label %}{{ summary.sell.updated_label }}{% endif %}
                      </div>
                    {% endif %}
                  {% else %}
                    <div class="text-body-secondary small">Cotacao indisponivel.</div>
                    {% if summary.sell.error_label %}
                      <div class="text-danger small">{{ summary.sell.error_label }}</div>
                    {% endif %}
                  {% endif %}
                </div>
              </div>
            </div>
            <div class="border rounded-3 p-3">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <div class="text-uppercase small text-success fw-semibold">{{ summary.buy.label }}</div>
                  <div class="fw-semibold">{{ summary.buy.ticker|default:"--" }}</div>
                  {% if summary.buy.name %}
                    <div class="text-body-secondary small">{{ summary.buy.name }}</div>
                  {% endif %}
                </div>
                <div class="text-end">
                  {% if summary.buy.price_label %}
                    <div class="fw-semibold">{{ summary.buy.price_label }}</div>
                    {% if summary.buy.source_label or summary.buy.updated_label %}
                      <div class="text-body-tertiary small">
                        {% if summary.buy.source_label %}{{ summary.buy.source_label }}{% endif %}
                        {% if summary.buy.source_label and summary.buy.updated_label %}&bull; {% endif %}
                        {% if summary.buy.updated_label %}{{ summary.buy.updated_label }}{% endif %}
                      </div>
                    {% endif %}
                  {% else %}
                    <div class="text-body-secondary small">Cotacao indisponivel.</div>
                    {% if summary.buy.error_label %}
                      <div class="text-danger small">{{ summary.buy.error_label }}</div>
                    {% endif %}
                  {% endif %}
                </div>
              </div>
            </div>
            {% if summary.pair_metrics_display %}
              <div class="border rounded-3 p-3 bg-body-tertiary">
                <dl class="row small mb-0">
                  {% for metric in summary.pair_metrics_display %}
                    <dt class="col-6 text-body-secondary">{{ metric.label }}</dt>
                    <dd class="col-6 text-end">{{ metric.value }}</dd>
                  {% endfor %}
                </dl>
              </div>
            {% elif summary.pair_metrics_payload is not None %}
              <div class="border rounded-3 p-3 bg-body-tertiary small text-body-secondary">
                Métricas do par indisponíveis no momento.
              </div>
            {% endif %}
          </div>
          <p class="small text-body-tertiary mb-0">
            Cotacoes obtidas via Yahoo Finance ao carregar a pagina. Ajuste a janela ou os tickers para atualizar.
          </p>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="card shadow-sm rounded-4 soft-card mt-3">
  <div class="card-body">
    <h2 class="h6 fw-semibold mb-3">Valores</h2>
    <form method="get" class="row gy-3 gx-2">
      {% for key, value in request.GET.items %}
        {% if key != "valor" and key != "capital" %}
          <input type="hidden" name="{{ key }}" value="{{ value }}">
        {% endif %}
      {% endfor %}
      <div class="col-md-6">
        <label for="valorOperacao" class="form-label small text-body-secondary">Valor disponivel</label>
        <div class="input-group input-group-sm">
          <span class="input-group-text">R$</span>
          <input type="text"
                 class="form-control"
                 id="valorOperacao"
                 name="valor"
                 inputmode="decimal"
                 placeholder="10000.00"
                 value="{{ valuation.input_display }}">
        </div>
        {% if valuation.suggested_label %}
          <div class="form-text text-body-secondary">
            Valor minimo recomendado: {{ valuation.suggested_label }}
            {% if valuation.input_adjusted %}
              (ajustado automaticamente)
            {% endif %}
          </div>
        {% endif %}
        {% if valuation.input_adjusted_message %}
          <div class="form-text text-warning">{{ valuation.input_adjusted_message }}</div>
        {% endif %}
      </div>
      <div class="col-md-3 d-flex align-items-end">
        <button type="submit" class="btn btn-outline-primary btn-sm">Calcular</button>
      </div>
    </form>

    {% if valuation.error %}
      <div class="alert alert-warning small mt-3 mb-0">{{ valuation.error }}</div>
    {% elif valuation.has_result %}
      <div class="mt-3">
        <dl class="row small mb-2">
          <dt class="col-sm-4 text-body-secondary">Lotes de venda (100)</dt>
          <dd class="col-sm-8 fw-semibold">{{ valuation.lots }}</dd>
          <dt class="col-sm-4 text-body-secondary">Quantidade vendida</dt>
          <dd class="col-sm-8">{{ valuation.shares }} acoes</dd>
          <dt class="col-sm-4 text-body-secondary">Quantidade comprada</dt>
          <dd class="col-sm-8">{{ valuation.shares_buy|default:valuation.shares }} acoes</dd>
          <dt class="col-sm-4 text-body-secondary">Proporcao long/short</dt>
          <dd class="col-sm-8">{{ valuation.proporcao_label }}</dd>
          {% if valuation.capital_informado_label %}
            <dt class="col-sm-4 text-body-secondary">Capital informado</dt>
            <dd class="col-sm-8">{{ valuation.capital_informado_label }}</dd>
          {% endif %}
          <dt class="col-sm-4 text-body-secondary">Capital utilizado</dt>
          <dd class="col-sm-8">{{ valuation.capital_label }}</dd>
          <dt class="col-sm-4 text-body-secondary">Venda (recebe)</dt>
          <dd class="col-sm-8">{{ valuation.sell_label }}</dd>
          <dt class="col-sm-4 text-body-secondary">Compra (paga)</dt>
          <dd class="col-sm-8">{{ valuation.buy_label }}</dd>
          <dt class="col-sm-4 text-body-secondary">Saldo</dt>
          <dd class="col-sm-8">
            {{ valuation.net_label }} ({{ valuation.net_direction }})
          </dd>
          <dt class="col-sm-4 text-body-secondary">Valor minimo recomendado</dt>
          <dd class="col-sm-8">{{ valuation.minimum_label }}</dd>
        </dl>
        <p class="small text-body-secondary mb-0">{{ valuation.description }}</p>
      </div>
    {% endif %}
  </div>
</div>
{% endblock %}
