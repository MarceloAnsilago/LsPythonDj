{% extends "_base.html" %}

{% block extra_head %}
  <script src="https://unpkg.com/htmx.org@1.9.12"></script>
{% endblock %}

{% block content %}
<div class="py-3">
  <div class="card shadow-sm rounded-4 soft-card mb-3">
    <div class="card-body">
      <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
        <div>
          <h1 class="h5 mb-1 fw-semibold">Analise - {{ pair.left.ticker }} x {{ pair.right.ticker }}</h1>
          <div class="text-body-secondary small">
            Janela atual: {{ window }}d{% if source %} (origem: {{ source }}){% endif %}
          </div>
        </div>
        <div class="d-flex align-items-center gap-2 flex-wrap">
          <label for="selWindow" class="form-label mb-0 small text-body-secondary">Janela</label>
          <select id="selWindow"
                  name="window"
                  class="form-select form-select-sm"
                  hx-get="{% url 'pairs:analysis_zseries' %}?{{ request.GET.urlencode }}"
                  hx-target="#analysisPanel"
                  hx-include="#selWindow"
                  hx-trigger="change"
                  hx-swap="innerHTML">
            {% for w in windows %}
              <option value="{{ w }}" {% if w == window %}selected{% endif %}>{{ w }}d</option>
            {% endfor %}
          </select>
          <button class="btn btn-primary btn-sm"
                  hx-get="{% url 'pairs:analysis_zseries' %}?{{ request.GET.urlencode }}"
                  hx-include="#selWindow"
                  hx-target="#analysisPanel"
                  hx-swap="innerHTML">
            Atualizar grafico
          </button>
          <a class="btn btn-outline-secondary btn-sm"
             id="startOperationBtn"
             data-base-url="{% url 'core:operacoes' %}"
             data-source="analysis"
             {% if pair.pk %}
               data-mode="pair"
               data-pair="{{ pair.pk }}"
             {% else %}
               data-mode="tickers"
               data-left="{{ pair.left.ticker }}"
               data-right="{{ pair.right.ticker }}"
             {% endif %}>
            Iniciar operacao
          </a>
        </div>
      </div>
    </div>
  </div>

  <div id="analysisPanel"
       hx-get="{% url 'pairs:analysis_zseries' %}?{{ request.GET.urlencode }}"
       hx-include="#selWindow"
       hx-trigger="load"
       hx-swap="innerHTML">
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  (function () {
    const btn = document.getElementById("startOperationBtn");
    if (!btn) {
      return;
    }
    const selectEl = document.getElementById("selWindow");
    const baseUrl = btn.dataset.baseUrl || "{% url 'core:operacoes' %}";
    const mode = btn.dataset.mode || "tickers";
    const source = btn.dataset.source || "analysis";
    const pairId = btn.dataset.pair || "";
    const leftTicker = btn.dataset.left || "";
    const rightTicker = btn.dataset.right || "";

    const buildHref = () => {
      const params = new URLSearchParams();
      if (selectEl && selectEl.value) {
        params.set("window", selectEl.value);
      }
      if (source) {
        params.set("source", source);
      }
      if (mode === "pair" && pairId) {
        params.set("pair", pairId);
      } else if (mode === "tickers") {
        if (leftTicker) {
          params.set("left", leftTicker);
        }
        if (rightTicker) {
          params.set("right", rightTicker);
        }
      }
      const base = baseUrl.endsWith("?") ? baseUrl.slice(0, -1) : baseUrl;
      const qs = params.toString();
      btn.href = qs ? `${base}?${qs}` : base;
    };

    if (selectEl) {
      selectEl.addEventListener("change", buildHref);
    }
    buildHref();
  })();
</script>
{% endblock %}
