{% comment %}
Snippet usado no retorno do hunt_start e no polling do hunt_status.
NÃƒO estende _base.html. Ã‰ apenas um pedaÃ§o de HTML.
{% endcomment %}

<div
  id="huntStatus"
  {% if job_id %}
    hx-get="{% url 'pairs:hunt_status' job_id %}"
    hx-trigger="every 1s"
    hx-swap="outerHTML"
  {% endif %}
  class="mb-2">

  {% if not data %}
    <div class="alert alert-secondary py-2 mb-0 shadow-sm rounded-3">
      <div class="d-flex align-items-center gap-2">
        <div class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></div>
        <div>Iniciando caÃ§aâ€¦</div>
      </div>
    </div>

  {% else %}

    {% if data.state == "waiting" %}
      <div class="alert alert-warning py-2 mb-2 shadow-sm rounded-3">
        <div class="fw-semibold">Nenhum par aprovado na janela {{ data.window }}d.</div>
        <div class="small text-body-secondary">
          Avancar para a proxima janela ({{ data.next_window }}d)?
        </div>
        <div class="d-flex gap-2 mt-2">
          <form
            hx-post="{% url 'pairs:hunt_decision' job_id %}"
            hx-target="#huntStatus"
            hx-swap="outerHTML"
            class="d-inline">
            {% csrf_token %}
            <input type="hidden" name="action" value="continue">
            <button class="btn btn-sm btn-warning">Ir para {{ data.next_window }}d</button>
          </form>
          <form
            hx-post="{% url 'pairs:hunt_decision' job_id %}"
            hx-target="#huntStatus"
            hx-swap="outerHTML"
            class="d-inline">
            {% csrf_token %}
            <input type="hidden" name="action" value="cancel">
            <button class="btn btn-sm btn-outline-secondary">Cancelar busca</button>
          </form>
        </div>
      </div>

    {% elif data.state == "running" %}
      <div class="alert alert-info py-2 mb-2 shadow-sm rounded-3">
        <div class="d-flex align-items-center justify-content-between">
          <div class="fw-semibold">
            CaÃ§ando
            {% if data.window %} â€” janela <code>{{ data.window }}d</code>{% endif %}
            {% if data.left and data.right %} â€” {{ data.left }} â€” {{ data.right }}{% endif %}
          </div>
          <div class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></div>
        </div>

        {% if data.total %}
          {# pct = (i / total) * 100 em inteiro #}
          {% widthratio data.i|default:0 data.total 100 as pct %}
    <div class="progress mt-2" role="progressbar"
      aria-valuemin="0" aria-valuemax="{{ data.total }}"
      aria-valuenow="{{ data.i|default:0 }}"
      style="height: 0.9rem;">
      <div class="progress-bar progress-bar-striped progress-bar-animated bg-info"
        data-width="{{ pct }}"></div>
    </div>
          <div class="mt-1 small text-body-secondary">
            {{ data.i|default:0 }}/{{ data.total }} â€” {{ pct }}%
          </div>
        {% else %}
          <div class="progress mt-2" style="height: 0.9rem;">
              <div class="progress-bar progress-bar-striped progress-bar-animated bg-info" style="width: 100%;"></div>
          </div>
        {% endif %}
        {% if data.phase == "window_next" %}
          <div class="alert alert-warning py-1 px-2 mt-2 mb-0 small rounded-3">
            Nenhum par aprovado na janela {{ data.window }}d; testando a proxima ({{ data.next_window }}d).
          </div>
        {% endif %}
      </div>

    {% elif data.state == "done" %}
      {% with r=data.result %}
        <div class="alert {% if r.cancelled %}alert-warning{% else %}alert-success{% endif %} py-2 mb-2 shadow-sm rounded-3">
          {% if r.cancelled %}
            Busca cancelada pelo usuario{% if r.window %} apos a janela {{ r.window }}d{% endif %}.
          {% elif r.found %}
            âœ… Encontrados {{ r.approved_ids|length }} pares na janela {{ r.window }}d.
          {% else %}
            ðŸ˜• Nenhum par aprovado nas janelas testadas.
          {% endif %}
          <div class="mt-2">
            <a class="btn btn-sm btn-success-subtle border-success-subtle" href="{% url 'pairs:home' %}">
              Atualizar pÃ¡gina
            </a>
          </div>
        </div>
      {% endwith %}

    {% elif data.state == "error" %}
      <div class="alert alert-danger py-2 mb-2 shadow-sm rounded-3">
        Erro na caÃ§a: {{ data.error }}
      </div>

    {% else %}
      <div class="alert alert-secondary py-2 mb-2 shadow-sm rounded-3">
        Aguardandoâ€¦
      </div>
    {% endif %}

  {% endif %}

  {% if log_rows %}
    <div class="card shadow-sm mt-2">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="fw-semibold">Resultados provisÃ³rios</div>
          <a
            class="btn btn-sm btn-outline-primary"
            href="{% url 'pairs:hunt_export' job_id %}"
          >
            Baixar CSV
          </a>
        </div>
        <div class="table-responsive" style="max-height: 220px; overflow-y: auto;">
          <table class="table table-sm mb-0">
            <thead>
              <tr>
                <th>Par</th>
                <th>Status</th>
                <th>Janela</th>
                <th>Compute (ms)</th>
                <th>Mensagem</th>
              </tr>
            </thead>
            <tbody>
              {% for row in log_rows|slice:"-10:" %}
                <tr>
                  <td>{{ row.pair_label }}</td>
                  <td>
                    {% if row.status == "approved" %}
                      <span class="badge bg-success">Aprovado</span>
                    {% else %}
                      <span class="badge bg-secondary">{{ row.status|capfirst }}</span>
                    {% endif %}
                  </td>
                  <td>{{ row.window }}</td>
                  <td>{{ row.compute_ms }}</td>
                  <td>{{ row.message }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  {% endif %}
</div>

<script>
  // Ensure we set progress-bar width from data-width when using template expressions
  (function(){
    try {
      var root = document.getElementById('huntStatus');
      if (!root) return;
      var bars = root.querySelectorAll('.progress-bar[data-width]');
      bars.forEach(function(bar){
        var w = bar.getAttribute('data-width');
        if (w !== null) {
          // Ensure numeric and clamp between 0 and 100
          var n = Number(w) || 0;
          if (n < 0) n = 0;
          if (n > 100) n = 100;
          bar.style.width = n + '%';
        }
      });
    } catch (e) {
      // fail silently; this script is just an enhancement to avoid template CSS linting errors
      console && console.warn && console.warn('huntStatus script error', e);
    }
  })();
</script>
