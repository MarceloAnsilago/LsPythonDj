{% extends "_base.html" %}
{% load static %}
{% load widget_tweaks %}

{% block extra_head %}
<style>
  .asset-icon {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: rgba(15, 23, 42, 0.08);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 1.35rem;
    position: relative;
    color: #0f172a;
  }
  .asset-icon::before {
    content: "★";
  }
  .asset-icon img {
    position: absolute;
    inset: 4px;
    width: calc(100% - 8px);
    height: calc(100% - 8px);
    border-radius: 50%;
    object-fit: cover;
    opacity: 0;
    transition: opacity 0.25s ease;
  }
  .asset-icon.asset-icon--loaded {
    color: transparent;
  }
  .asset-icon.asset-icon--loaded img {
    opacity: 1;
  }
</style>
{% endblock %}
{% block content %}
{% with ticker=view.object.ticker|default:"" %}
  <div class="d-flex align-items-center gap-3 mb-3">
    <span class="asset-icon" aria-hidden="true">
      {% if ticker %}
        <img
          src="https://raw.githubusercontent.com/thefintz/icones-b3/main/icones/{{ ticker|upper }}.png"
          alt="{{ ticker|upper }}"
          loading="lazy"
        >
      {% endif %}
    </span>
    <h2 class="mb-0">{{ view.object|yesno:"Editar Ativo,Novo Ativo" }}</h2>
  </div>
{% endwith %}

<form method="post" class="card p-3 p-md-4 shadow-sm rounded-3">
  {% csrf_token %}

  {% if form.non_field_errors %}
    <div class="alert alert-danger">{{ form.non_field_errors }}</div>
  {% endif %}

  <div class="row g-3">
    <div class="col-12 col-md-4">
      <label class="form-label" for="{{ form.ticker.id_for_label }}">Ticker</label>
      {{ form.ticker|add_class:"form-control text-uppercase" }}
      {{ form.ticker.errors }}
    </div>

    <div class="col-12 col-md-4">
      <label class="form-label" for="{{ form.ticker_yf.id_for_label }}">Yahoo Finance</label>
      {{ form.ticker_yf|add_class:"form-control text-uppercase" }}
      <div class="form-text">Adiciona <code>.SA</code> automaticamente quando necessário.</div>
      {{ form.ticker_yf.errors }}
    </div>

    <div class="col-12 col-md-4">
      <label class="form-label" for="{{ form.name.id_for_label }}">Nome</label>
      {{ form.name|add_class:"form-control" }}
      {{ form.name.errors }}
    </div>

    <div class="col-12 d-flex align-items-center gap-3">
      <div class="form-check">
        {{ form.is_active|add_class:"form-check-input" }}
        <label class="form-check-label ms-1" for="{{ form.is_active.id_for_label }}">Ativa</label>
      </div>
      {{ form.is_active.errors }}
    </div>
  </div>

  <div class="d-flex gap-2 mt-4">
    <button class="btn btn-primary">Salvar</button>
    <a class="btn btn-outline-secondary" href="{% url 'acoes:lista' %}">Cancelar</a>
  </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
(function () {
  const fTicker = document.getElementById('id_ticker');
  const fYF = document.getElementById('id_ticker_yf');

  function ensureYFFormat() {
    if (!fYF) return;
    let yf = (fYF.value || '').toUpperCase().trim();
    if (!yf && fTicker?.value) {
      yf = fTicker.value.toUpperCase().trim();
    }
    if (yf && !yf.includes('.')) {
      yf = `${yf}.SA`;
    }
    fYF.value = yf;
  }

  if (fTicker) {
    fTicker.addEventListener('input', function () {
      this.value = this.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
    });
    fTicker.addEventListener('blur', ensureYFFormat);
  }

  if (fYF) {
    fYF.addEventListener('blur', function () {
      fYF.value = fYF.value.toUpperCase().trim();
      ensureYFFormat();
    });
  }
})();
</script>
<script>
document.addEventListener('DOMContentLoaded', function () {
  document.querySelectorAll('.asset-icon img').forEach((img) => {
    img.addEventListener('load', function () {
      const wrapper = this.closest('.asset-icon');
      if (wrapper) {
        wrapper.classList.add('asset-icon--loaded');
      }
    });
    img.addEventListener('error', function () {
      const wrapper = this.closest('.asset-icon');
      if (wrapper) {
        wrapper.classList.add('asset-icon--missing');
      }
      this.remove();
    });
  });
});
</script>
{% endblock %}
